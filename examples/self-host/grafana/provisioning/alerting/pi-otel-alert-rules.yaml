apiVersion: 1

groups:
  - orgId: 1
    name: pi-otel-availability
    folder: Pi OTel Alerts
    interval: 1m
    rules:
      - uid: pi-otel-collector-down
        title: Pi OTel Collector Down
        condition: B
        data:
          - refId: A
            relativeTimeRange:
              from: 300
              to: 0
            datasourceUid: prometheus
            model:
              editorMode: code
              expr: max(up{job="pi-otel-collector"})
              instant: true
              intervalMs: 1000
              maxDataPoints: 43200
              refId: A
          - refId: B
            relativeTimeRange:
              from: 0
              to: 0
            datasourceUid: "__expr__"
            model:
              conditions:
                - evaluator:
                    params:
                      - 1
                    type: lt
                  operator:
                    type: and
                  query:
                    params:
                      - A
                  reducer:
                    params: []
                    type: last
                  type: query
              datasource:
                type: "__expr__"
                uid: "__expr__"
              expression: A
              intervalMs: 1000
              maxDataPoints: 43200
              refId: B
              type: classic_conditions
        dashboardUid: pi-otel-ops-live
        panelId: 6
        noDataState: Alerting
        execErrState: Error
        for: 5m
        annotations:
          summary: pi-otel-collector scrape target is down.
          runbook: docs/operations.md
        labels:
          service: pi-opentelemetry
          severity: critical
          category: availability
        isPaused: false

  - orgId: 1
    name: pi-otel-reliability
    folder: Pi OTel Alerts
    interval: 1m
    rules:
      - uid: pi-otel-tool-error-warn
        title: Pi Tool Error Rate High (Warning)
        condition: B
        data:
          - refId: A
            relativeTimeRange:
              from: 600
              to: 0
            datasourceUid: prometheus
            model:
              editorMode: code
              expr: sum(rate(pi_tool_result_count_total{success="false"}[5m])) / clamp_min(sum(rate(pi_tool_result_count_total[5m])), 0.0001)
              instant: true
              intervalMs: 1000
              maxDataPoints: 43200
              refId: A
          - refId: B
            relativeTimeRange:
              from: 0
              to: 0
            datasourceUid: "__expr__"
            model:
              conditions:
                - evaluator:
                    params:
                      - 0.05
                    type: gt
                  operator:
                    type: and
                  query:
                    params:
                      - A
                  reducer:
                    params: []
                    type: last
                  type: query
              datasource:
                type: "__expr__"
                uid: "__expr__"
              expression: A
              intervalMs: 1000
              maxDataPoints: 43200
              refId: B
              type: classic_conditions
        dashboardUid: pi-otel-ops-live
        panelId: 9
        noDataState: OK
        execErrState: Error
        for: 10m
        annotations:
          summary: Tool error rate is above 5% for 10m.
          runbook: docs/operations.md
        labels:
          service: pi-opentelemetry
          severity: warning
          category: reliability
        isPaused: false

      - uid: pi-otel-tool-error-crit
        title: Pi Tool Error Rate High (Critical)
        condition: B
        data:
          - refId: A
            relativeTimeRange:
              from: 600
              to: 0
            datasourceUid: prometheus
            model:
              editorMode: code
              expr: sum(rate(pi_tool_result_count_total{success="false"}[5m])) / clamp_min(sum(rate(pi_tool_result_count_total[5m])), 0.0001)
              instant: true
              intervalMs: 1000
              maxDataPoints: 43200
              refId: A
          - refId: B
            relativeTimeRange:
              from: 0
              to: 0
            datasourceUid: "__expr__"
            model:
              conditions:
                - evaluator:
                    params:
                      - 0.10
                    type: gt
                  operator:
                    type: and
                  query:
                    params:
                      - A
                  reducer:
                    params: []
                    type: last
                  type: query
              datasource:
                type: "__expr__"
                uid: "__expr__"
              expression: A
              intervalMs: 1000
              maxDataPoints: 43200
              refId: B
              type: classic_conditions
        dashboardUid: pi-otel-ops-live
        panelId: 9
        noDataState: OK
        execErrState: Error
        for: 10m
        annotations:
          summary: Tool error rate is above 10% for 10m.
          runbook: docs/operations.md
        labels:
          service: pi-opentelemetry
          severity: critical
          category: reliability
        isPaused: false

  - orgId: 1
    name: pi-otel-latency
    folder: Pi OTel Alerts
    interval: 1m
    rules:
      - uid: pi-otel-turn-p95-warn
        title: Pi Turn p95 Latency High (Warning)
        condition: B
        data:
          - refId: A
            relativeTimeRange:
              from: 900
              to: 0
            datasourceUid: prometheus
            model:
              editorMode: code
              expr: histogram_quantile(0.95, sum(rate(pi_turn_duration_seconds_bucket[5m])) by (le))
              instant: true
              intervalMs: 1000
              maxDataPoints: 43200
              refId: A
          - refId: B
            relativeTimeRange:
              from: 0
              to: 0
            datasourceUid: "__expr__"
            model:
              conditions:
                - evaluator:
                    params:
                      - 8
                    type: gt
                  operator:
                    type: and
                  query:
                    params:
                      - A
                  reducer:
                    params: []
                    type: last
                  type: query
              datasource:
                type: "__expr__"
                uid: "__expr__"
              expression: A
              intervalMs: 1000
              maxDataPoints: 43200
              refId: B
              type: classic_conditions
        dashboardUid: pi-otel-ops-live
        panelId: 7
        noDataState: OK
        execErrState: Error
        for: 15m
        annotations:
          summary: Turn p95 latency is above 8s for 15m.
          runbook: docs/operations.md
        labels:
          service: pi-opentelemetry
          severity: warning
          category: latency
        isPaused: false

      - uid: pi-otel-turn-p95-crit
        title: Pi Turn p95 Latency High (Critical)
        condition: B
        data:
          - refId: A
            relativeTimeRange:
              from: 900
              to: 0
            datasourceUid: prometheus
            model:
              editorMode: code
              expr: histogram_quantile(0.95, sum(rate(pi_turn_duration_seconds_bucket[5m])) by (le))
              instant: true
              intervalMs: 1000
              maxDataPoints: 43200
              refId: A
          - refId: B
            relativeTimeRange:
              from: 0
              to: 0
            datasourceUid: "__expr__"
            model:
              conditions:
                - evaluator:
                    params:
                      - 12
                    type: gt
                  operator:
                    type: and
                  query:
                    params:
                      - A
                  reducer:
                    params: []
                    type: last
                  type: query
              datasource:
                type: "__expr__"
                uid: "__expr__"
              expression: A
              intervalMs: 1000
              maxDataPoints: 43200
              refId: B
              type: classic_conditions
        dashboardUid: pi-otel-ops-live
        panelId: 7
        noDataState: OK
        execErrState: Error
        for: 15m
        annotations:
          summary: Turn p95 latency is above 12s for 15m.
          runbook: docs/operations.md
        labels:
          service: pi-opentelemetry
          severity: critical
          category: latency
        isPaused: false

  - orgId: 1
    name: pi-otel-efficiency
    folder: Pi OTel Alerts
    interval: 5m
    rules:
      - uid: pi-otel-cost-per-turn-reg
        title: Pi Cost per Turn Regression (Warning)
        condition: B
        data:
          - refId: A
            relativeTimeRange:
              from: 1800
              to: 0
            datasourceUid: prometheus
            model:
              editorMode: code
              expr: (sum(increase(pi_cost_usage_USD_total[1h])) / clamp_min(sum(increase(pi_turn_count_total[1h])), 1)) / clamp_min(avg_over_time((sum(increase(pi_cost_usage_USD_total[1h])) / clamp_min(sum(increase(pi_turn_count_total[1h])), 1))[7d:1h]), 0.000001)
              instant: true
              intervalMs: 1000
              maxDataPoints: 43200
              refId: A
          - refId: B
            relativeTimeRange:
              from: 0
              to: 0
            datasourceUid: "__expr__"
            model:
              conditions:
                - evaluator:
                    params:
                      - 1.3
                    type: gt
                  operator:
                    type: and
                  query:
                    params:
                      - A
                  reducer:
                    params: []
                    type: last
                  type: query
              datasource:
                type: "__expr__"
                uid: "__expr__"
              expression: A
              intervalMs: 1000
              maxDataPoints: 43200
              refId: B
              type: classic_conditions
        dashboardUid: pi-otel-efficiency-decision
        panelId: 7
        noDataState: OK
        execErrState: Error
        for: 30m
        annotations:
          summary: Cost per turn is more than 30% above 7-day baseline.
          runbook: docs/operations.md
        labels:
          service: pi-opentelemetry
          severity: warning
          category: cost
        isPaused: false
